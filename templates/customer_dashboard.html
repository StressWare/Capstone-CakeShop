<!-- customer_dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Dashboard - Ms. Brave Cake Shop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='customer_dashboard.css') }}">
   <link href="../static/chatbot.css" rel="stylesheet">
  
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-light bg-light fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="/">üéÇ Ms. Brave Cake Shop</a>
    <button class="btn btn-outline-dark" data-bs-toggle="offcanvas" data-bs-target="#menu">
      ‚ò∞ Menu
    </button>
  </div>
</nav>

<!-- OFFCANVAS MENU -->
<div class="offcanvas offcanvas-end" id="menu">
  <div class="offcanvas-header">
    <h5>Navigate</h5>
    <button class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <a class="d-block mb-2" href="#profile">Profile</a>
    <a class="d-block mb-2" href="#orders">Order History</a>
  </div>
</div>

<div class="container mt-5 pt-5">
  <!-- PROFILE SECTION -->
  <section id="profile" class="mb-5">
    <h2 class="mb-3">My Profile</h2>
    <div class="card p-3">
      <p><strong>Full Name:</strong> {{ customer.fname }}</p>
      <p><strong>Username:</strong> {{ customer.username }}</p>
      <p><strong>Contact:</strong> {{ customer.number }}</p>
      <p><strong>Address:</strong> {{ customer.address }}</p>
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editProfileModal">
        Edit Profile
      </button>
    </div>
  </section>

  <!-- ORDER HISTORY SECTION -->
  <section id="orders">
    <h2 class="mb-3">Order History</h2>
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>Order ID</th>
          <th>Items</th>
          <th>Total (‚Ç±)</th>
          <th>Delivery Date</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for order in orders %}
        <tr>
          <td>{{ order.id }}</td>
          <td>{{ order.item }}</td>
          <td>{{ "%.2f"|format(order.amount) }}</td>
          <td>{{ order.delivery_date.strftime('%b %d, %Y - %I:%M %p') }}</td>
          <td>{{ order.status }}</td>
          <td>
            <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#orderDetailsModal{{ order.id }}">
              View
            </button>
          </td>
        </tr>

        <!-- Order Details Modal -->
        <div class="modal fade" id="orderDetailsModal{{ order.id }}" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <p><strong>Items:</strong> {{ order.item }}</p>
                <p><strong>Amount:</strong> ‚Ç±{{ "%.2f"|format(order.amount) }}</p>
                <p><strong>Delivery Date:</strong> {{ order.delivery_date.strftime('%b %d, %Y - %I:%M %p') }}</p>
                <p><strong>Status:</strong> {{ order.status }}</p>
                <p><strong>Occasion:</strong> {{ order.customer.occasion }}</p>
                <p><strong>Celebrant:</strong> {{ order.customer.celebrant or 'N/A' }}</p>
                <p><strong>Age:</strong> {{ order.customer.age or 'N/A' }}</p>
                <p><strong>Address:</strong> {{ order.customer.address }}</p>
                {% if order.notes %}
                <div class="alert alert-info mt-3">
                  <strong>üìù Special Instructions:</strong>
                  <p class="mb-0">{{ order.notes }}</p>
                </div>
                {% endif %}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
        {% else %}
        <tr>
          <td colspan="6" class="text-center text-muted">No orders found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- EDIT PROFILE MODAL -->
  <div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="{{ url_for('edit_customer_profile') }}">
          <div class="modal-header">
            <h5 class="modal-title">Edit Profile</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label>Full Name</label>
              <input type="text" name="full_name" class="form-control" value="{{ customer.fname }}" required>
            </div>
            <div class="mb-3">
              <label>Username</label>
              <input type="text" name="username" class="form-control" value="{{ customer.username }}" required>
            </div>
            <div class="mb-3">
              <label>Contact</label>
              <input type="text" name="contact" class="form-control" value="{{ customer.number }}" required>
            </div>
            <div class="mb-3">
              <label>Address</label>
              <input type="text" name="address" class="form-control" value="{{ customer.address }}" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- CHATBOT FLOATING WIDGET -->
<div id="chatbot-widget" class="chatbot-container">
  <!-- Floating Button -->
  <button class="chatbot-toggle-btn" id="chatbotToggle" title="Open Chat">
    <span class="chat-icon">üí¨</span>
  </button>

  <!-- Chat Window -->
  <div class="chatbot-window" id="chatbotWindow" style="display: none;">
    <!-- Header -->
    <div class="chatbot-header">
      <div class="header-content">
        <h5>üéÇ Ms. Brave Support</h5>
        <p class="status-text">Online - Instant replies</p>
      </div>
      <button class="close-btn" id="chatbotClose">‚úï</button>
    </div>

    <!-- Messages Container -->
    <div class="chatbot-messages" id="chatbotMessages">
      <div class="message bot-message">
        <p>üëã Hey there! Welcome to Ms. Brave Cake Shop support. How can we help you today?</p>
      </div>
    </div>

    <!-- FAQ Buttons Section -->
    <div class="faq-buttons" id="faqButtonsContainer">
      <button class="faq-btn" data-question="how to order">
        üìù How to Order?
      </button>
      <button class="faq-btn" data-question="delivery time">
        üöö Delivery Time?
      </button>
      <button class="faq-btn" data-question="customization">
        üé® Customization?
      </button>
      <button class="faq-btn" data-question="payment methods">
        üí≥ Payment Methods?
      </button>
      <button class="faq-btn" data-question="return policy">
        üîÑ Return Policy?
      </button>
    </div>

    <!-- Support Escalation -->
    <div class="support-section">
      <p class="support-text">Can't find what you need?</p>
      <button class="btn-support" id="escalateBtn">
        üë§ Chat with Owner
      </button>
    </div>

    <!-- Input Area -->
    <div class="chatbot-input-area">
      <input 
        type="text" 
        id="chatbotInput" 
        class="chatbot-input" 
        placeholder="Ask a question..."
        autocomplete="off"
      >
      <button class="send-btn" id="chatbotSendBtn">‚û§</button>
    </div>
  </div>
</div>

<script>
// ===== CHATBOT WIDGET LOGIC =====
class ChatbotWidget {
  constructor() {
    this.userId = this.getUserIdFromSession();
    this.conversationId = this.getOrCreateConversationId();
    this.toggleBtn = document.getElementById('chatbotToggle');
    this.window = document.getElementById('chatbotWindow');
    this.closeBtn = document.getElementById('chatbotClose');
    this.messagesContainer = document.getElementById('chatbotMessages');
    this.input = document.getElementById('chatbotInput');
    this.sendBtn = document.getElementById('chatbotSendBtn');
    this.faqBtns = document.querySelectorAll('.faq-btn');
    this.escalateBtn = document.getElementById('escalateBtn');

    this.init();
  }

  init() {
    // Toggle chat window
    this.toggleBtn.addEventListener('click', () => this.toggleWindow());
    this.closeBtn.addEventListener('click', () => this.toggleWindow());

    // Send message events
    this.sendBtn.addEventListener('click', () => this.sendMessage());
    this.input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.sendMessage();
    });

    // FAQ buttons
    this.faqBtns.forEach(btn => {
      btn.addEventListener('click', () => this.handleFaqClick(btn));
    });

    // Escalate button (placeholder for now)
    this.escalateBtn.addEventListener('click', () => {
      alert('Chat with owner feature coming soon!');
    });

    // Load message history
    this.loadMessages();
  }

  getUserIdFromSession() {
    // Get user ID from page (you'll need to add this to your template)
    return document.body.dataset.userId || 'unknown';
  }

  getOrCreateConversationId() {
    let convId = localStorage.getItem('chatbot_conversation_id');
    if (!convId) {
      convId = 'conv_' + Date.now();
      localStorage.setItem('chatbot_conversation_id', convId);
    }
    return convId;
  }

  toggleWindow() {
    if (this.window.style.display === 'none') {
      this.window.style.display = 'flex';
      this.input.focus();
    } else {
      this.window.style.display = 'none';
    }
  }

  handleFaqClick(btn) {
    const question = btn.dataset.question;
    this.input.value = question;
    this.sendMessage();
  }

  async sendMessage() {
    const message = this.input.value.trim();
    if (!message) return;

    // Show customer message
    this.addMessage(message, 'customer');
    this.input.value = '';

    // Show loading indicator
    this.addMessage('...', 'bot-loading');

    try {
      // Send to backend API
      const response = await fetch('/api/send-message', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: message,
          user_id: this.userId,
          conversation_id: this.conversationId
        })
      });

      const data = await response.json();

      // Remove loading indicator
      const loadingMsg = this.messagesContainer.lastChild;
      if (loadingMsg && loadingMsg.textContent.includes('...')) {
        loadingMsg.remove();
      }

      if (data.success) {
        // Show bot response
        this.addMessage(data.response, 'bot');
      } else {
        this.addMessage('Sorry, something went wrong. Please try again.', 'bot');
      }
    } catch (error) {
      console.error('Error:', error);
      const loadingMsg = this.messagesContainer.lastChild;
      if (loadingMsg) loadingMsg.remove();
      this.addMessage('Connection error. Please try again.', 'bot');
    }
  }

  addMessage(text, sender) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `message ${sender}-message`;
    
    if (sender === 'bot-loading') {
      msgDiv.innerHTML = '<p>Thinking<span class="typing-dots">...</span></p>';
    } else {
      msgDiv.innerHTML = `<p>${text}</p>`;
    }

    this.messagesContainer.appendChild(msgDiv);
    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
  }

  async loadMessages() {
    try {
      const response = await fetch(`/api/messages/${this.userId}/${this.conversationId}`);
      const data = await response.json();

      if (data.success && data.messages) {
        // Clear initial message and reload
        this.messagesContainer.innerHTML = '';
        data.messages.forEach(msg => {
          this.addMessage(msg.text, msg.sender);
        });
      }
    } catch (error) {
      console.error('Error loading messages:', error);
    }
  }
}

// Initialize chatbot when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  new ChatbotWidget();
});
</script>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
